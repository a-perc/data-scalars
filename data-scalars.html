<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-combo-box/vaadin-combo-box-light.html">


<!--
Automatic representation of a scalar value as Polymer Elements (Iron and Paper) – in either read-only or editable mode.

‹data-scalars› elements consume an immutable data egg data structure and produce suitable Polymer elements to represent that value. The data egg is a simple structure, which contains the scalar value, its type and logical formatting hints.

Designed to work hand-in-hand with data nuggets data structures delivered by ‹data-pipes›, although both can be used independently.

Example of usage:

  <data-point selector="coord" data="{{dataNugget}}" item="{{dataEgg}}">
    <data-scalars data="{{dataEgg}}" editable="true|false"></data-scalars>
  </data-point>
-->



<dom-module id="data-scalars">
  <template>
    <style>
      :host {
        display: block;
        @apply --layout-flex;
        @apply --layout-horizontal;
      }

      div.content {
        width: 100%;
        height: 23px;
        position: relative;
        box-sizing: border-box;
        border: 1px solid transparent; /* Make sure every cell have same height */
      }

      div.content.error {
        border: 1px solid rgb(255, 41, 41);
        background-color: rgb(248, 183, 183);
      }

      div[hidden]{
        display: none;
      }

      select,
      input,
      iron-input,
      vaadin-combo-box-light {
        height: 20px;
        width: 100%;
        box-sizing: border-box;
      }

      select[disabled],
      input[disabled]{
        border: none;
        background: transparent;
      }
    </style>
    <div id="scalar" class$="content [[_getErrorClass(data)]]" title="[[_getTitle(data)]]">
      <template is="dom-if" if="[[_isElementTypePrimitive(data)]]">
        <input
          class="input"
          type="[[_getElementType(data)]]"
          value$="[[_value]]"
          disabled="[[disabled]]"
          on-change="_onChange">
      </template>
      <template is="dom-if" if="[[_isElementType(data, 'dropdown')]]">
        <template is="dom-if" if="[[!disabled]]">
          <vaadin-combo-box-light
            class="input"
            items="[[_suggestions]]"
            value="[[_value]]"
            attr-for-value="bind-value"
            on-value-changed="_onChange"
            allow-custom-value
            disabled="[[disabled]]">
            <iron-input>
              <input disabled="[[disabled]]">
            </iron-input>
          </vaadin-combo-box-light>
        </template>
        <input class="input" disabled="[[disabled]]" hidden="[[!disabled]]" value="[[_value]]">
      </template>
    </div>
  </template>

  <script>
    /**
     * `data-scalars`
     * Automatic representation of a scalar value
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class DataScalars extends Polymer.Element {
      static get is() { return 'data-scalars'; }
      static get properties() {
        return {
          /**
           * The given `dataEgg`. A `dataEgg` is one element of the `dataNugget`.
           * Example:
           *
           *    dataEgg = {value: …, schema: …, format: … [, metadata: …]}
           */
          data: {
            type: Object,
            notify: true
          },

          name: {
            type: String,
          },

          /** Is this scalar editable or not ? (WIP) */
          editable: {
            type: Boolean,
            notify: true,
            value: false,
            reflectToAttribute: true
          },

          /** Is this scalar input disabled ? */
          disabled: {
            type: Boolean,
            notify: true,
            value: false,
            reflectToAttribute: true,
            observer: "_disabledChanged"
          },

          /**
           *
           */
          _elementType: {
            type: String,
            value: "input"
          },

          _suggestions: {
            type: Array,
            computed: "_computeSuggestions( data)"
          },

          _value: {
            type: String,
            computed: "_computeValue( data)"
          },

          _implementedTypes: {
            type: Array,
            value: () => {
              return ["text", "dropdown"];
            }
          }
        };
      }

      ready() {
        super.ready();
      }

      _computeValue( data){
        if(!data){return}
        var value = data.get("value") || "";
        this._forceValue(value);
        return value;
      }

      _disabledChanged(disabled){
        if(!this.data){return;}
        if(this._value) {
          // Make sure the value is updated when editing
          this._forceValue(this._computeValue(this.data));
        }
      }

      // Make sure that the user edition is deleted !!!!!!!!!!
      _forceValue(value){
        var scalar = this.$.scalar;
        if(scalar) {
          var input = scalar.querySelector(".input");
          if(input){
            input.value = value;
          }
        };
        this._value = value;
      }

      _computeSuggestions( data){
        return [
          {label: "predefined1", value: "predefined1"},
          {label: "predefined2", value: "predefined2"},
          {label: "predefined3", value: "predefined3"},
          {label: "predefined4", value: "predefined4"},
          {label: "predefined5", value: "predefined5"},
        ]
      }


      /** TODO: this should be computed */
      _getTitle(data){
        if( !data) {return undefined; }
        if( !data.get("error")){ return data.get("value"); }
        return "Error: "+data.get("error");
      }

      _getErrorClass(data){
        if(!data || !data.get("error")){return;}
        if(data.get("error")){
          return "error"
        }
      }

      _onChange(e){
        var value = e.currentTarget.value;
        var event = new CustomEvent('change', {'detail': {name: this.name, value: value}})
        this.dispatchEvent(event);
      }

      _getElementType(data){
        if(data && data.get("schema") && data.get("schema").get("type")){
          return  data.get("schema").get("type");
        } else {
          return 'text';
        }
      }

      _isElementTypePrimitive(data){
        var primitiveTypes = ['text', 'date', 'datetime-local', 'number'];
        if(data && data.get("schema") && data.get("schema").get("type")){
          return primitiveTypes.indexOf(
            data.get("schema").get("type")) > -1;
        } else {
          return true;
        }
      }

      /**
        * Returns true if the data is of type `elType`.
        * By default and if the type is not specified, it will return true as if `elType` == 'text'
        * TODO: use _implementedTypes and throw a warning
        */
      _isElementType(data, elType){
        if(data && data.get("schema") && data.get("schema").get("type")){
          return data.get("schema").get("type") == elType;
        } else {
          return elType == 'text';
        }
      }
    }

    window.customElements.define(DataScalars.is, DataScalars);
  </script>
</dom-module>
